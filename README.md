**Бесплатная автоматизация создания конфигов телефонов в FreePBX 16.**

**Введение**
При управлении большим количеством телефонов в FreePBX, ручная настройка становится неэффективной. Важно иметь возможность быстро и безошибочно обновлять конфигурации телефонов, особенно при добавлении новых номеров или замене устройств.

**Подготовка**
Предполагается, что вы уже освоили Auto provisioning и настроили получение параметров на телефонах через DHCP сервер с использованием параметра option 66. 
В этой статье мы не будем углубляться в эти детали, так как существует множество ресурсов, которые подробно описывают этот процесс.


**Настройка Endpoint Manager (платная функция)**
В FreePBX 16 доступна функция Endpoint Manager, которая позволяет автоматически настраивать телефоны. Однако, даже если вы не приобрели эту функцию, вы можете использовать поле для MAC-адреса в настройках телефонного номера. 
Вкладка "Other" в параметрах Endpoint позволяет указать MAC-адрес телефона.
Смотри скриншот "Вписываем МАК адрес.png"

После этого необходимо найти, куда записывается это поле в базе данных Asterisk. Мы обнаружили таблицу endpoint_extensions, где хранятся данные настройки. Заметим как в этой таблице хранится номер телефона, к нему добавляется -1.
Смотри скриншот "Место хранения мак адресов в базе данных FreePBX.png"

Далее мы можем создать скрипт, который будет обращаться к таблице и генерировать конфигурационные файлы, помещая их в папку TFTP-сервера. Пример скрипта представлен ниже:

**update_configs.sh**

#!/bin/bash

# Параметры подключения к базе данных
DB_USER="freepbxuser"
DB_PASS="you_password"
DB_NAME="asterisk"
DB_TABLE="endpoint_extensions"

# Запрос к базе данных
QUERY="SELECT ext, mac FROM $DB_TABLE"

# Выполнение запроса и обработка результата
mysql -u $DB_USER -p$DB_PASS -D $DB_NAME -e "$QUERY" | while read -r ext mac; do
# Пропускаем заголовок таблицы
if [[ "$ext" == "ext" ]]; then
continue
fi

# Обрезаем последние два символа из ext
EXTEN="${ext::-2}"
MAC="$mac"

# Путь к шаблону и целевому файлу
TEMPLATE="/tftpboot/example.xml"
TARGET="/tftpboot/cfg$MAC.xml"

# Копирование шаблона и замена меток
if [[ -f "$TEMPLATE" ]]; then
cp "$TEMPLATE" "$TARGET"
sed -i "s/MACADDR/$MAC/g" "$TARGET"
sed -i "s/EXTEN/$EXTEN/g" "$TARGET"
echo "Файл $TARGET успешно создан и обновлен."
else
echo "Шаблон $TEMPLATE не найден."
fi
Пояснения к скрипту

Как видно, что в БД хранение номера телефона в таблице организовано с дополнением -1, для этого мы удаляем EXTEN="${ext::-2}" два символа справа.
В этом скрипте мы используем файл шаблона конфигурации example.xml, в котором в нужных местах установлены метки, которые мы заменяем на соответствующие значения MAC-адреса и номера телефона. 
После выполнения скрипта телефоны автоматически подхватывают новые конфигурации.

Скрипт запускается каждые 15 минут с помощью cron, что позволяет поддерживать актуальность конфигураций. Для этого необходимо добавить строчку */15 * * * * /scripts/update_configs.sh
Заключение

Автоматизация создания конфигурационных файлов для телефонов в FreePBX значительно упрощает процесс управления большим количеством устройств. 
Используя описанный подход, вы можете избежать рутинной работы и снизить вероятность ошибок при настройке. 
Надеюсь, данный материал будет полезен и поможет вам в вашей работе. Это решение значительно улучшает процесс управления телефонами.
